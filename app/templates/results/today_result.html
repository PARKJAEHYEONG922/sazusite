{% extends "layout/base.html" %}

{% block title %}{{ service.title }} ê²°ê³¼ - {{ site_config.site_name if site_config else "ëª…ì›”í—Œ" }}{% endblock %}

{% block meta_description %}{{ data.name if data else 'ê³ ê°' }}ë‹˜ì˜ {{ service.title }} í’€ì´ ê²°ê³¼ì…ë‹ˆë‹¤. {{ service.character_name }}ì´ ìì„¸íˆ í’€ì–´ë“œë ¸ìŠµë‹ˆë‹¤.{% endblock %}

{% block meta_keywords %}{{ service.title }}, {% if service.code == 'today' %}ì˜¤ëŠ˜ì˜ ìš´ì„¸, ë ë³„ìš´ì„¸{% elif service.code == 'newyear2026' %}2026ë…„ ìš´ì„¸, ì‹ ë…„ìš´ì„¸{% elif service.code == 'match' %}ê¶í•©, ì‚¬ì£¼ê¶í•©{% elif service.code == 'dream' %}ê¿ˆí•´ëª½, ê¿ˆí’€ì´{% endif %}, ìš´ì„¸ ê²°ê³¼{% endblock %}

{% block og_title %}{{ data.name if data else 'ê³ ê°' }}ë‹˜ì˜ {{ service.title }} ê²°ê³¼{% endblock %}

{% block og_description %}{{ service.character_name }}ì´ ìì„¸íˆ í’€ì–´ë“œë¦° {{ service.title }} ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.{% endblock %}

{% block og_image %}{{ service.character_image if service.character_image else url_for('static', path='/images/og-fortune.jpg') }}{% endblock %}

{% block extra_css %}
<style>
    .result-header {
        text-align: center;
        padding: 100px 20px 40px;
        margin-top: 60px;
    }

    .character-emoji {
        font-size: 60px;
        margin-bottom: 15px;
    }

    .character-image {
        width: 100%;
        max-width: 500px;
        height: auto;
        aspect-ratio: 3 / 4;
        object-fit: cover;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        margin: 0 auto 20px;
        display: block;
    }

    @media (max-width: 768px) {
        .character-image {
            max-width: 90vw;
        }
    }

    .result-title {
        font-size: 32px;
        margin-bottom: 10px;
    }

    .result-date {
        color: #a0a0a0;
        font-size: 14px;
        margin-bottom: 10px;
    }

    .cache-notice {
        display: inline-block;
        padding: 8px 16px;
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4CAF50;
        border-radius: 20px;
        color: #4CAF50;
        font-size: 14px;
        margin-top: 10px;
    }

    .result-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
    }

    /* ì¸ì‚¬ë§ ìŠ¤íƒ€ì¼ */
    .greeting-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
        font-size: 18px;
        line-height: 1.8;
        text-align: center;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    /* ìš´ì„¸ ì„¹ì…˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .fortune-card {
        background: #ffffff;
        border: 2px solid rgba(0, 0, 0, 0.05);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s;
        color: #000000;
    }

    .fortune-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: rgba(102, 126, 234, 0.3);
    }

    .fortune-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(0, 0, 0, 0.05);
    }

    .fortune-card-icon {
        font-size: 28px;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    }

    .fortune-card-title {
        font-size: 20px;
        font-weight: 700;
        color: #333;
        margin: 0;
    }

    .fortune-card-content {
        font-size: 16px;
        line-height: 1.8;
        color: #444;
    }

    /* í–‰ìš´ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
    .lucky-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .lucky-item {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
    }

    .lucky-item-label {
        font-size: 13px;
        color: #666;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .lucky-item-value {
        font-size: 18px;
        font-weight: 700;
        color: #667eea;
    }

    /* ì¡°ì–¸ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .advice-section {
        display: grid;
        gap: 15px;
        margin-top: 15px;
    }

    .advice-item {
        padding: 15px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.02);
        border-left: 4px solid #667eea;
    }

    .advice-item.avoid {
        border-left-color: #f5576c;
        background: rgba(245, 87, 108, 0.05);
    }

    .advice-item.recommend {
        border-left-color: #4CAF50;
        background: rgba(76, 175, 80, 0.05);
    }

    .advice-item-title {
        font-weight: 700;
        margin-bottom: 8px;
        color: #333;
        font-size: 15px;
    }

    .advice-item-content {
        color: #555;
        line-height: 1.6;
    }

    .final-advice {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        border: none;
        padding: 20px;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: #333;
        border-radius: 12px;
        margin-top: 10px;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    @media (max-width: 768px) {
        .result-container {
            padding: 0 15px;
        }

        .greeting-section {
            padding: 20px;
            font-size: 16px;
        }

        .fortune-card {
            padding: 20px;
        }

        .fortune-card-title {
            font-size: 18px;
        }

        .lucky-items {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="result-header">
    <div class="character-emoji">
        {% if service.character_image %}
            {% if service.character_image.endswith(('.mp4', '.webm')) or '.mp4?' in service.character_image or '.webm?' in service.character_image %}
                <video autoplay loop muted playsinline class="character-image" preload="metadata">
                    <source src="{{ service.character_image }}" type="video/{{ 'mp4' if '.mp4' in service.character_image else 'webm' }}">
                    ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </video>
            {% else %}
                <img src="{{ service.character_image }}" alt="{{ service.character_name }}" class="character-image">
            {% endif %}
        {% else %}
            {{ service.character_emoji }}
        {% endif %}
    </div>
    <h1 class="result-title">{{ service.title }}</h1>
    <p class="result-date">{{ today.strftime('%Yë…„ %mì›” %dì¼') }}</p>
    {% if is_cached %}
    <div class="cache-notice">ì˜¤ëŠ˜ ì´ë¯¸ ë³´ì‹  ìš´ì„¸ì˜ˆìš”</div>
    {% endif %}
</div>

{% if result.daily_fortune_info %}
<div class="result-container">
    <div class="fortune-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 30px;">
        <div class="fortune-card-header" style="border-bottom: 2px solid rgba(255, 255, 255, 0.2);">
            <span style="font-size: 28px;">ğŸ“…</span>
            <h3 class="fortune-card-title" style="color: white;">ì˜¤ëŠ˜ì˜ ì²œê°„ì§€ì§€</h3>
        </div>
        <div style="margin-top: 20px;">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 48px; font-weight: bold; margin-bottom: 10px;">
                    {{ result.daily_fortune_info.ganzhi_full }}
                </div>
                <div style="font-size: 24px; margin-bottom: 5px;">
                    {{ result.daily_fortune_info.ganzhi_kr }}
                </div>
                <div style="font-size: 18px; opacity: 0.9;">
                    ì˜¤í–‰: {{ result.daily_fortune_info.ohang }} | ì‹ ì‚´: {{ result.daily_fortune_info.sinsal }}
                </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <span style="font-size: 32px; font-weight: bold;">
                        {% if result.daily_fortune_info.luck_level == 'ëŒ€ê¸¸' %}
                            ğŸŒŸ {{ result.daily_fortune_info.luck_level }} ğŸŒŸ
                        {% elif result.daily_fortune_info.luck_level == 'ì¤‘ê¸¸' or result.daily_fortune_info.luck_level == 'ì†Œê¸¸' %}
                            âœ¨ {{ result.daily_fortune_info.luck_level }} âœ¨
                        {% elif result.daily_fortune_info.luck_level == 'í‰' %}
                            â­ {{ result.daily_fortune_info.luck_level }} â­
                        {% elif result.daily_fortune_info.luck_level == 'ì†Œí‰' or result.daily_fortune_info.luck_level == 'ì¤‘í‰' %}
                            â˜ï¸ {{ result.daily_fortune_info.luck_level }} â˜ï¸
                        {% else %}
                            âš ï¸ {{ result.daily_fortune_info.luck_level }} âš ï¸
                        {% endif %}
                    </span>
                </div>
                <p style="font-size: 16px; line-height: 1.8; text-align: center; margin: 0;">
                    {{ result.daily_fortune_info.description }}
                </p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background: rgba(76, 175, 80, 0.3); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">âœ… ì¢‹ì€ ì¼</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                        {% for activity in result.daily_fortune_info.good_activities %}
                        <li>{{ activity }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <div style="background: rgba(244, 67, 54, 0.3); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">âŒ ë‚˜ìœ ì¼</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                        {% for activity in result.daily_fortune_info.bad_activities %}
                        <li>{{ activity }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if result.compatibility_info %}
<div class="result-container">
    <div class="fortune-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; margin-bottom: 30px;">
        <div class="fortune-card-header" style="border-bottom: 2px solid rgba(255, 255, 255, 0.2);">
            <span style="font-size: 28px;">ğŸ’•</span>
            <h3 class="fortune-card-title" style="color: white;">ì‚¬ì£¼ ê¶í•© ë¶„ì„</h3>
        </div>
        <div style="margin-top: 20px;">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 56px; font-weight: bold; margin-bottom: 10px;">
                    {{ result.compatibility_info.score }}ì 
                </div>
                <div style="font-size: 28px; margin-bottom: 15px;">
                    {{ result.compatibility_info.level }}
                </div>
                <div style="display: flex; justify-content: center; gap: 30px; font-size: 18px;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">{{ request_data.name }}</div>
                        <div style="font-size: 24px; font-weight: bold;">{{ result.compatibility_info.person1.day_pillar }}</div>
                        <div style="font-size: 16px;">{{ result.compatibility_info.person1.ohang }}</div>
                    </div>
                    <div style="display: flex; align-items: center; font-size: 32px;">ğŸ’«</div>
                    <div>
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">{{ request_data.partner_name }}</div>
                        <div style="font-size: 24px; font-weight: bold;">{{ result.compatibility_info.person2.day_pillar }}</div>
                        <div style="font-size: 16px;">{{ result.compatibility_info.person2.ohang }}</div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">ğŸ”¥ ì˜¤í–‰ ê´€ê³„: {{ result.compatibility_info.ohang_relation.type }}</div>
                    <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ result.compatibility_info.ohang_relation.description }}</p>
                </div>
                <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">â˜¯ï¸ ì¼ì£¼ ê´€ê³„: {{ result.compatibility_info.ilju_compatibility.gan_relation }}</div>
                    <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ result.compatibility_info.ilju_compatibility.description }}</p>
                </div>
                <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">ğŸŒ™ ì§€ì§€ ê´€ê³„: {{ result.compatibility_info.jiji_relation.type }}</div>
                    <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ result.compatibility_info.jiji_relation.description }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if result.year_fortune_info %}
<div class="result-container">
    <div class="fortune-card" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; margin-bottom: 30px;">
        <div class="fortune-card-header" style="border-bottom: 2px solid rgba(255, 255, 255, 0.2);">
            <span style="font-size: 28px;">ğŸŠ</span>
            <h3 class="fortune-card-title" style="color: white;">2026ë…„ ì²œê°„ì§€ì§€</h3>
        </div>
        <div style="margin-top: 20px;">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 48px; font-weight: bold; margin-bottom: 10px;">
                    {{ result.year_fortune_info.ganzhi_full }}
                </div>
                <div style="font-size: 20px; opacity: 0.95; margin-bottom: 10px;">
                    {{ result.year_fortune_info.description }}
                </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">ğŸ“… ì›”ë³„ ì²œê°„ì§€ì§€</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 14px;">
                    {% for month_data in result.year_fortune_info.monthly_ganzhi %}
                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-weight: bold;">{{ month_data.month }}ì›”</div>
                        <div>{{ month_data.ganzhi_hanja }}</div>
                        <div style="font-size: 12px; opacity: 0.9;">({{ month_data.ganzhi_kr }})</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 20px;">
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">âœ¨ 2026ë…„ ëŒ€ê¸¸ì¼</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                    {% for lucky_day in result.year_fortune_info.lucky_days %}
                    <div style="background: rgba(255, 215, 0, 0.2); border-radius: 8px; padding: 10px;">
                        <div style="font-weight: bold;">{{ lucky_day.date }}</div>
                        <div>{{ lucky_day.ganzhi }} - {{ lucky_day.sinsal }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="result-container" id="fortuneResult">
    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
</div>

{% include "components/share_buttons.html" %}

<div class="actions">
    <a href="/" class="btn btn-primary">ë©”ì¸ìœ¼ë¡œ</a>
    <a href="/fortune/{{ service.code }}" class="btn btn-secondary">ë‹¤ì‹œ ë³´ê¸°</a>
</div>

<script>
    // ìš´ì„¸ í…ìŠ¤íŠ¸ ì›ë³¸
    const fortuneText = {{ result.result_text | tojson }};

    // ì„¹ì…˜ë³„ ì•„ì´ì½˜ ë§¤í•‘
    const sectionIcons = {
        'ì´ìš´': 'â­',
        'ì¢…í•©ìš´': 'â­',
        'ê¸ˆì „ìš´': 'ğŸ’°',
        'ì—°ì• ': 'ğŸ’–',
        'ëŒ€ì¸ìš´': 'ğŸ‘¥',
        'ì—°ì• /ëŒ€ì¸ìš´': 'ğŸ’–',
        'ì§ì¥': 'ğŸ’¼',
        'ì‚¬ì—…ìš´': 'ğŸ“ˆ',
        'ì§ì¥Â·ì‚¬ì—…ìš´': 'ğŸ’¼',
        'ê±´ê°•ìš´': 'ğŸ’ª',
        'í•™ì—…': 'ğŸ“š',
        'ì„±ì·¨ìš´': 'ğŸ¯',
        'í•™ì—…Â·ì„±ì·¨ìš´': 'ğŸ“š',
        'í–‰ìš´': 'ğŸ€',
        'í–‰ìš´ ìš”ì†Œ': 'ğŸ€',
        'ì¡°ì–¸': 'ğŸ’¡',
        'ì˜¤ëŠ˜ì˜ ì¡°ì–¸': 'ğŸ’¡',
        // ê¿ˆí•´ëª½ ê´€ë ¨ ì„¹ì…˜
        'ê¿ˆì´ ì „í•˜ëŠ” ëœ»': 'ğŸŒ™',
        'ê¿ˆ ì† ì§•í‘œë“¤': 'ğŸ”®',
        'ê¸¸ëª½ì¸ê°€, í‰ëª½ì¸ê°€': 'âš–ï¸',
        'í•œ ë§ˆë””ë¡œ ì •ë¦¬í•˜ìë©´': 'ğŸ“'
    };

    function parseFortuneText(text) {
        const lines = text.split('\n');
        const sections = [];
        let currentSection = null;
        let greeting = '';

        for (let line of lines) {
            line = line.trim();
            if (!line) continue;

            // **ì¸ì‚¬ë§** ë“±ì˜ í—¤ë” ì œê±°í•˜ê³  ì§ì ‘ ì¸ì‚¬ë§ ì¶”ì¶œ
            if (!currentSection && !line.startsWith('**') && line.length > 0) {
                greeting += line + ' ';
                continue;
            }

            // ** ì œëª© ** í˜•ì‹ì˜ ì„¹ì…˜ í—¤ë” ì°¾ê¸°
            const headerMatch = line.match(/^\*\*(.+?)\*\*$/);
            if (headerMatch) {
                if (currentSection) {
                    sections.push(currentSection);
                }

                let title = headerMatch[1].trim();
                // ìˆ«ìì™€ ì  ì œê±° (ì˜ˆ: "1. ì˜¤ëŠ˜ì˜ ì´ìš´" -> "ì´ìš´")
                title = title.replace(/^\d+\.\s*/, '');
                title = title.replace(/^ì˜¤ëŠ˜ì˜\s*/, '');

                // ì•„ì´ì½˜ ì°¾ê¸°
                let icon = 'âœ¨';
                for (const [key, value] of Object.entries(sectionIcons)) {
                    if (title.includes(key)) {
                        icon = value;
                        break;
                    }
                }

                currentSection = {
                    title: title,
                    icon: icon,
                    content: '',
                    isLucky: title.includes('í–‰ìš´'),
                    isAdvice: title.includes('ì¡°ì–¸') || title.includes('ì˜¤ëŠ˜ì˜ ì¡°ì–¸')
                };
            } else if (currentSection) {
                currentSection.content += line + '\n';
            }
        }

        if (currentSection) {
            sections.push(currentSection);
        }

        return { greeting: greeting.trim(), sections };
    }

    function renderLuckySection(content) {
        const lines = content.split('\n').filter(l => l.trim());
        let html = '<div class="lucky-items">';

        for (const line of lines) {
            const match = line.match(/[-â€¢*]\s*(.+?):\s*(.+)/);
            if (match) {
                const label = match[1].replace('í–‰ìš´ì˜ ', '').trim();
                const value = match[2].trim();
                html += `
                    <div class="lucky-item">
                        <div class="lucky-item-label">${label}</div>
                        <div class="lucky-item-value">${value}</div>
                    </div>
                `;
            }
        }

        html += '</div>';
        return html;
    }

    function renderAdviceSection(content) {
        const lines = content.split('\n').filter(l => l.trim());

        // "í”¼í•´ì•¼ í• "ì´ë‚˜ "ì¶”ì²œ" í‚¤ì›Œë“œê°€ ìˆëŠ”ì§€ í™•ì¸
        const hasAdviceStructure = lines.some(line =>
            line.includes('í”¼í•´ì•¼ í• ') || line.includes('ì¶”ì²œ')
        );

        // í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ì¼ë°˜ ì½˜í…ì¸ ë¡œ ë Œë”ë§ (ê¿ˆí•´ëª½ ì¡°ì–¸ ë“±)
        if (!hasAdviceStructure) {
            return renderRegularContent(content);
        }

        // ê¸°ì¡´ ì¡°ì–¸ ì„¹ì…˜ ë Œë”ë§ ë¡œì§
        let html = '<div class="advice-section">';

        let currentType = null;
        let currentContent = '';

        for (const line of lines) {
            if (line.includes('í”¼í•´ì•¼ í• ')) {
                if (currentType) {
                    html += renderAdviceItem(currentType, currentContent);
                }
                currentType = 'avoid';
                currentContent = '';
            } else if (line.includes('ì¶”ì²œ')) {
                if (currentType) {
                    html += renderAdviceItem(currentType, currentContent);
                }
                currentType = 'recommend';
                currentContent = '';
            } else if (line.includes('ì¡°ì–¸') && !line.includes('í”¼í•´ì•¼') && !line.includes('ì¶”ì²œ')) {
                if (currentType) {
                    html += renderAdviceItem(currentType, currentContent);
                }
                // ê°ì„± ì¡°ì–¸ì€ ë§ˆì§€ë§‰ì— íŠ¹ë³„í•˜ê²Œ í‘œì‹œ
                const adviceMatch = line.match(/[-â€¢]\s*(.+?):\s*(.+)/);
                if (adviceMatch) {
                    html += `<div class="final-advice">${adviceMatch[2]}</div>`;
                }
                currentType = null;
                currentContent = '';
            } else if (currentType) {
                const match = line.match(/[-â€¢]\s*(.+?):\s*(.+)/);
                if (match) {
                    currentContent = match[2];
                } else if (!line.startsWith('-') && !line.startsWith('â€¢')) {
                    currentContent += ' ' + line;
                }
            }
        }

        if (currentType && currentContent) {
            html += renderAdviceItem(currentType, currentContent);
        }

        html += '</div>';
        return html;
    }

    function renderAdviceItem(type, content) {
        const title = type === 'avoid' ? 'âš ï¸ í”¼í•´ì•¼ í•  í–‰ë™' : 'âœ… ì¶”ì²œ í–‰ë™';
        return `
            <div class="advice-item ${type}">
                <div class="advice-item-title">${title}</div>
                <div class="advice-item-content">${content}</div>
            </div>
        `;
    }

    function renderRegularContent(content) {
        // - ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ì„ ë¶„ë¦¬í•˜ì—¬ ê°ê° ë¬¸ë‹¨ìœ¼ë¡œ ì²˜ë¦¬
        const lines = content.split('\n').map(line => line.trim()).filter(line => line);
        let html = '';

        for (const line of lines) {
            // - ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° ì œê±°
            let processedLine = line.replace(/^-\s*/, '');

            // **í…ìŠ¤íŠ¸** í˜•ì‹ì„ <strong>í…ìŠ¤íŠ¸</strong>ë¡œ ë³€í™˜
            processedLine = processedLine.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // ê° ì¤„ì„ ë¬¸ë‹¨ìœ¼ë¡œ í‘œì‹œ
            html += `<p style="margin-bottom: 12px; line-height: 1.8;">${processedLine}</p>`;
        }

        return html;
    }

    function renderFortune() {
        const { greeting, sections } = parseFortuneText(fortuneText);
        const container = document.getElementById('fortuneResult');

        let html = '';

        // ì¸ì‚¬ë§ ì„¹ì…˜
        if (greeting) {
            html += `<div class="greeting-section">${greeting}</div>`;
        }

        // ê° ì„¹ì…˜ ë Œë”ë§
        for (const section of sections) {
            html += `
                <div class="fortune-card">
                    <div class="fortune-card-header">
                        <div class="fortune-card-icon">${section.icon}</div>
                        <h3 class="fortune-card-title">${section.title}</h3>
                    </div>
                    <div class="fortune-card-content">
            `;

            if (section.isLucky) {
                html += renderLuckySection(section.content);
            } else if (section.isAdvice) {
                html += renderAdviceSection(section.content);
            } else {
                html += renderRegularContent(section.content);
            }

            html += `
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
    renderFortune();
</script>
{% endblock %}
