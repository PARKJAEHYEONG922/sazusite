{% extends "layout/admin_base.html" %}

{% block page_title %}ê³„ì • ì„¤ì •{% endblock %}

{% block extra_css %}
<style>
    .alert {
        padding: 16px 20px;
        margin-bottom: 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .settings-container {
        max-width: 600px;
        margin: 0 auto;
    }

    .settings-section {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .settings-section h2 {
        font-size: 20px;
        margin-bottom: 20px;
        color: #2d3748;
        font-weight: 700;
        padding-bottom: 12px;
        border-bottom: 2px solid #e2e8f0;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #4a5568;
        font-weight: 600;
        font-size: 14px;
    }

    .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
        box-sizing: border-box;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .password-strength {
        margin-top: 8px;
        height: 4px;
        background: #e2e8f0;
        border-radius: 2px;
        overflow: hidden;
        display: none;
    }

    .password-strength-bar {
        height: 100%;
        width: 0%;
        transition: all 0.3s;
    }

    .password-strength.weak .password-strength-bar {
        width: 33%;
        background: #f56565;
    }

    .password-strength.medium .password-strength-bar {
        width: 66%;
        background: #ed8936;
    }

    .password-strength.strong .password-strength-bar {
        width: 100%;
        background: #48bb78;
    }

    .password-hint {
        margin-top: 8px;
        font-size: 12px;
        color: #718096;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #ffffff;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .info-box {
        background: #ebf8ff;
        border-left: 4px solid #3182ce;
        padding: 16px;
        margin-bottom: 24px;
        border-radius: 4px;
    }

    .info-box h3 {
        color: #2c5282;
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .info-box ul {
        margin: 0;
        padding-left: 20px;
        color: #2d3748;
        font-size: 13px;
    }

    .info-box li {
        margin-bottom: 4px;
    }

    .current-user {
        background: #f7fafc;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 24px;
    }

    .current-user strong {
        color: #2d3748;
    }

    .btn-logout {
        display: inline-block;
        padding: 10px 24px;
        background: #e53e3e;
        color: #ffffff;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }

    .btn-logout:hover {
        background: #c53030;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="settings-container">
    <!-- ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ -->
    {% if success %}
    <div class="alert alert-success">
        âœ… {{ success }}
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-error">
        âŒ {{ error }}
    </div>
    {% endif %}

    <div class="settings-section">
        <h2>ê³„ì • ì •ë³´</h2>

        <div class="current-user">
            <strong>í˜„ì¬ ë¡œê·¸ì¸:</strong> {{ username }}
        </div>

        <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
        <div style="text-align: center; margin: 20px 0;">
            <a href="/admin/logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>

        <div class="info-box">
            <h3>ğŸ”’ ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ê·œì¹™</h3>
            <ul>
                <li>ìµœì†Œ 12ì ì´ìƒ</li>
                <li>ì˜ë¬¸ ëŒ€ë¬¸ì, ì†Œë¬¸ì í¬í•¨</li>
                <li>ìˆ«ì í¬í•¨</li>
                <li>íŠ¹ìˆ˜ë¬¸ì í¬í•¨ (!@#$%^&* ë“±)</li>
                <li>ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë‹¨ì–´ ì‚¬ìš© ê¸ˆì§€</li>
            </ul>
        </div>

        <form method="POST" action="/admin/settings/account/change-password" id="changePasswordForm">
            <div class="form-group">
                <label for="current_password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ *</label>
                <input type="password" id="current_password" name="current_password" required
                       placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="form-group">
                <label for="new_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ *</label>
                <input type="password" id="new_password" name="new_password" required
                       placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       minlength="12">
                <div class="password-strength" id="passwordStrength">
                    <div class="password-strength-bar"></div>
                </div>
                <div class="password-hint" id="passwordHint"></div>
            </div>

            <div class="form-group">
                <label for="confirm_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
                <input type="password" id="confirm_password" name="confirm_password" required
                       placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                       minlength="12">
            </div>

            <button type="submit" class="btn-primary" id="submitBtn">
                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordHint = document.getElementById('passwordHint');
    const form = document.getElementById('changePasswordForm');
    const submitBtn = document.getElementById('submitBtn');

    // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì²´í¬
    newPasswordInput.addEventListener('input', function() {
        const password = this.value;

        if (password.length === 0) {
            passwordStrength.style.display = 'none';
            passwordHint.textContent = '';
            return;
        }

        passwordStrength.style.display = 'block';

        // ê°•ë„ ê³„ì‚°
        let strength = 0;
        const checks = {
            length: password.length >= 12,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
        };

        strength = Object.values(checks).filter(Boolean).length;

        // ê°•ë„ í‘œì‹œ
        passwordStrength.className = 'password-strength';
        if (strength <= 2) {
            passwordStrength.classList.add('weak');
            passwordHint.textContent = 'âŒ ì•½í•¨: ë” ë³µì¡í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”';
            passwordHint.style.color = '#f56565';
        } else if (strength <= 4) {
            passwordStrength.classList.add('medium');
            passwordHint.textContent = 'âš ï¸ ë³´í†µ: íŠ¹ìˆ˜ë¬¸ìë¥¼ ì¶”ê°€í•˜ë©´ ë” ì•ˆì „í•©ë‹ˆë‹¤';
            passwordHint.style.color = '#ed8936';
        } else {
            passwordStrength.classList.add('strong');
            passwordHint.textContent = 'âœ… ê°•í•¨: ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤';
            passwordHint.style.color = '#48bb78';
        }
    });

    // í¼ ì œì¶œ ê²€ì¦
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        console.log('í¼ ì œì¶œ ì‹œì‘');

        const currentPassword = document.getElementById('current_password').value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        console.log('ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì‹œì‘');
        console.log('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´:', currentPassword.length);
        console.log('ìƒˆ ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´:', newPassword.length);
        console.log('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê¸¸ì´:', confirmPassword.length);

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!currentPassword || currentPassword.length === 0) {
            alert('âŒ [í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\ní˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!newPassword || newPassword.length === 0) {
            alert('âŒ [ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\nìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (newPassword.length < 12) {
            alert('âŒ [ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\nìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 12ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n\ní˜„ì¬ ì…ë ¥: ' + newPassword.length + 'ì');
            return;
        }

        if (!/[A-Z]/.test(newPassword)) {
            alert('âŒ [ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\nìƒˆ ë¹„ë°€ë²ˆí˜¸ì— ì˜ë¬¸ ëŒ€ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.\n\nì˜ˆì‹œ: A, B, C, Z ë“±');
            return;
        }

        if (!/[a-z]/.test(newPassword)) {
            alert('âŒ [ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\nìƒˆ ë¹„ë°€ë²ˆí˜¸ì— ì˜ë¬¸ ì†Œë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.\n\nì˜ˆì‹œ: a, b, c, z ë“±');
            return;
        }

        if (!/[0-9]/.test(newPassword)) {
            alert('âŒ [ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\nìƒˆ ë¹„ë°€ë²ˆí˜¸ì— ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.\n\nì˜ˆì‹œ: 0, 1, 2, 9 ë“±');
            return;
        }

        if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword)) {
            alert('âŒ [ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\nìƒˆ ë¹„ë°€ë²ˆí˜¸ì— íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.\n\nì˜ˆì‹œ: !@#$%^&* ë“±');
            return;
        }

        if (!confirmPassword || confirmPassword.length === 0) {
            alert('âŒ [ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì˜¤ë¥˜]\në¹„ë°€ë²ˆí˜¸ í™•ì¸ë€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('âŒ [ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì˜¤ë¥˜]\nìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
            confirmPasswordInput.focus();
            return;
        }

        if (currentPassword === newPassword) {
            alert('âŒ [ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜]\ní˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n\në³´ì•ˆì„ ìœ„í•´ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
            return;
        }

        console.log('âœ… í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ í†µê³¼, ì„œë²„ë¡œ ì œì¶œ');

        // ì œì¶œ
        submitBtn.disabled = true;
        submitBtn.textContent = 'ë³€ê²½ ì¤‘...';
        form.submit();
    });
</script>
{% endblock %}
