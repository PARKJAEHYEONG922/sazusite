{% extends "layout/admin_base.html" %}

{% block title %}로그 모니터링 - 명월헌 관리자{% endblock %}

{% block content %}
<div class="logs-container">
    <h1>로그 모니터링</h1>

    <!-- 탭 메뉴 -->
    <div class="tabs">
        <a href="/admin/logs?tab=errors" class="tab {{ 'active' if tab == 'errors' else '' }}">
            에러 로그
        </a>
        <a href="/admin/logs?tab=api" class="tab {{ 'active' if tab == 'api' else '' }}">
            API 사용
        </a>
        <a href="/admin/logs?tab=access" class="tab {{ 'active' if tab == 'access' else '' }}">
            접속 로그
        </a>
        <a href="/admin/logs?tab=rate-limit" class="tab {{ 'active' if tab == 'rate-limit' else '' }}">
            Rate Limit
        </a>
    </div>

    <!-- 에러 로그 탭 -->
    {% if tab == 'errors' %}
    <div class="tab-content">
        <div class="stats-summary">
            <div class="stat-card">
                <h3>24시간 에러</h3>
                <p class="stat-number">{{ error_count_24h }}</p>
            </div>
        </div>

        {% if error_stats %}
        <h2>에러 타입별 통계 (24시간)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>에러 타입</th>
                    <th>발생 횟수</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in error_stats %}
                <tr>
                    <td>{{ stat.type }}</td>
                    <td>{{ stat.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <h2>최근 에러 내역 (최근 50개)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>타입</th>
                    <th>메시지</th>
                    <th>서비스</th>
                    <th>IP</th>
                </tr>
            </thead>
            <tbody>
                {% for error in errors %}
                <tr>
                    <td>{{ error.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ error.error_type }}</td>
                    <td class="error-message">{{ error.error_message[:100] }}</td>
                    <td>{{ error.service_code or '-' }}</td>
                    <td>{{ error.client_ip or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- API 사용 로그 탭 -->
    {% if tab == 'api' %}
    <div class="tab-content">
        <div class="stats-summary">
            <div class="stat-card">
                <h3>총 API 호출 (7일)</h3>
                <p class="stat-number">{{ api_stats.total_calls }}</p>
            </div>
            <div class="stat-card">
                <h3>캐시 히트율</h3>
                <p class="stat-number">{{ "%.1f"|format(api_stats.cache_hit_rate) }}%</p>
            </div>
            <div class="stat-card">
                <h3>예상 비용 (7일)</h3>
                <p class="stat-number">${{ "%.4f"|format(api_stats.total_cost) }}</p>
            </div>
            <div class="stat-card">
                <h3>평균 응답시간</h3>
                <p class="stat-number">{{ "%.0f"|format(api_stats.avg_response_time_ms) }}ms</p>
            </div>
        </div>

        {% if api_by_service %}
        <h2>서비스별 API 사용량 (7일)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>서비스</th>
                    <th>호출 횟수</th>
                    <th>예상 비용</th>
                </tr>
            </thead>
            <tbody>
                {% for service in api_by_service %}
                <tr>
                    <td>{{ service.service }}</td>
                    <td>{{ service.count }}</td>
                    <td>${{ "%.4f"|format(service.cost) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <h2>최근 API 사용 내역 (최근 50개)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>서비스</th>
                    <th>모델</th>
                    <th>응답시간</th>
                    <th>캐시</th>
                </tr>
            </thead>
            <tbody>
                {% for log in api_logs %}
                <tr>
                    <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ log.service_code }}</td>
                    <td>{{ log.model }}</td>
                    <td>{{ log.response_time_ms or '-' }}ms</td>
                    <td>{{ '✓' if log.cache_hit else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- 접속 로그 탭 -->
    {% if tab == 'access' %}
    <div class="tab-content">
        <div class="stats-summary">
            <div class="stat-card">
                <h3>총 요청 (7일)</h3>
                <p class="stat-number">{{ access_stats.total_requests }}</p>
            </div>
            <div class="stat-card">
                <h3>운세 요청</h3>
                <p class="stat-number">{{ access_stats.fortune_requests }}</p>
            </div>
            <div class="stat-card">
                <h3>순 방문자</h3>
                <p class="stat-number">{{ access_stats.unique_visitors }}</p>
            </div>
        </div>

        {% if popular_services %}
        <h2>인기 서비스 (7일)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>서비스</th>
                    <th>이용 횟수</th>
                </tr>
            </thead>
            <tbody>
                {% for service in popular_services %}
                <tr>
                    <td>{{ service.service }}</td>
                    <td>{{ service.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <h2>최근 접속 내역 (최근 50개)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>URL</th>
                    <th>상태</th>
                    <th>IP</th>
                    <th>응답시간</th>
                </tr>
            </thead>
            <tbody>
                {% for log in access_logs %}
                <tr>
                    <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td class="url-cell">{{ log.url[:50] }}</td>
                    <td>{{ log.status_code }}</td>
                    <td>{{ log.client_ip }}</td>
                    <td>{{ log.response_time_ms or '-' }}ms</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Rate Limit 탭 -->
    {% if tab == 'rate-limit' %}
    <div class="tab-content">
        <div class="stats-summary">
            <div class="stat-card">
                <h3>총 위반 (7일)</h3>
                <p class="stat-number">{{ rate_limit_stats.total_violations }}</p>
            </div>
            <div class="stat-card">
                <h3>분당 제한 위반</h3>
                <p class="stat-number">{{ rate_limit_stats.minute_violations }}</p>
            </div>
            <div class="stat-card">
                <h3>일일 제한 위반</h3>
                <p class="stat-number">{{ rate_limit_stats.day_violations }}</p>
            </div>
            <div class="stat-card">
                <h3>고유 IP</h3>
                <p class="stat-number">{{ rate_limit_stats.unique_violators }}</p>
            </div>
        </div>

        {% if top_violators %}
        <h2>TOP 위반자 (7일)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>IP 주소</th>
                    <th>위반 횟수</th>
                </tr>
            </thead>
            <tbody>
                {% for violator in top_violators %}
                <tr>
                    <td>{{ violator.ip }}</td>
                    <td>{{ violator.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <h2>최근 위반 내역 (최근 50개)</h2>
        <table class="log-table">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>IP</th>
                    <th>타입</th>
                    <th>요청 수</th>
                    <th>최대 허용</th>
                </tr>
            </thead>
            <tbody>
                {% for log in rate_limit_logs %}
                <tr>
                    <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ log.client_ip }}</td>
                    <td>{{ log.limit_type }}</td>
                    <td>{{ log.current_count }}</td>
                    <td>{{ log.max_allowed }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<style>
.logs-container {
    padding: 20px;
}

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 2px solid #e0e0e0;
}

.tab {
    padding: 10px 20px;
    text-decoration: none;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab:hover {
    color: #333;
}

.tab.active {
    color: #8B4513;
    border-bottom-color: #8B4513;
    font-weight: bold;
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #666;
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
    color: #8B4513;
    margin: 0;
}

.log-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.log-table th,
.log-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.log-table th {
    background: #f5f5f5;
    font-weight: bold;
    color: #333;
}

.log-table tr:hover {
    background: #f9f9f9;
}

.error-message {
    max-width: 400px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.url-cell {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}
