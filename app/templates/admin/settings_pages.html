{% extends "layout/admin_base.html" %}

{% block page_title %}í˜ì´ì§€ ì„¤ì •{% endblock %}

{% block admin_content %}
<!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
{% if success or request.query_params.get('success') %}
<div class="alert alert-success">
    <span class="alert-icon">âœ“</span>
    <span class="alert-content">
        {% if request.query_params.get('success') == 'new_page_created' %}
            ìƒˆ í˜ì´ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
        {% elif request.query_params.get('success') == 'page_deleted' %}
            í˜ì´ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
        {% else %}
            {{ success }}
        {% endif %}
    </span>
</div>
{% endif %}

{% if error or request.query_params.get('error') %}
<div class="alert alert-error">
    <span class="alert-icon">âœ•</span>
    <span class="alert-content">{{ error or request.query_params.get('error') }}</span>
</div>
{% endif %}

<!-- í˜ì´ì§€ ì¶”ê°€ ë²„íŠ¼ -->
<div class="admin-section">
    <div class="admin-section-header">
        <div>
            <h2 class="admin-section-title">í˜ì´ì§€ ê´€ë¦¬</h2>
            <p class="admin-section-description">ìš´ì„¸ í˜ì´ì§€ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </div>
        <button type="button" class="btn btn-primary" onclick="showNewPageModal()">
            â• ìƒˆ í˜ì´ì§€ ì¶”ê°€
        </button>
    </div>
</div>

<!-- í˜ì´ì§€ ëª©ë¡ -->
{% for service in services %}
<div class="admin-section">
    <div class="admin-section-header">
        <div class="flex items-center gap-3">
            <div class="service-character">
                {% if service.character_form_image %}
                    {% if service.character_form_image.endswith(('.mp4', '.webm')) or '.mp4?' in service.character_form_image or '.webm?' in service.character_form_image %}
                        <video class="service-character-img" autoplay loop muted playsinline>
                            <source src="{{ service.character_form_image }}" type="video/{{ 'mp4' if '.mp4' in service.character_form_image else 'webm' }}">
                        </video>
                    {% else %}
                        <img src="{{ service.character_form_image }}" alt="{{ service.character_name }}" class="service-character-img">
                    {% endif %}
                {% elif service.character_image %}
                    {% if service.character_image.endswith(('.mp4', '.webm')) or '.mp4?' in service.character_image or '.webm?' in service.character_image %}
                        <video class="service-character-img" autoplay loop muted playsinline>
                            <source src="{{ service.character_image }}" type="video/{{ 'mp4' if '.mp4' in service.character_image else 'webm' }}">
                        </video>
                    {% else %}
                        <img src="{{ service.character_image }}" alt="{{ service.character_name }}" class="service-character-img">
                    {% endif %}
                {% else %}
                    <span class="service-character-emoji">{{ service.character_emoji }}</span>
                {% endif %}
            </div>
            <div>
                <h2 class="admin-section-title mb-1">{{ service.title }}</h2>
                <p class="admin-section-description mb-1">{{ service.subtitle }}</p>
                <p class="form-hint">{{ service.description }}</p>
                <span class="badge badge-default mt-2">{{ service.code }}</span>
            </div>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="toggleEdit('{{ service.code }}')">
                âœï¸ ìˆ˜ì •
            </button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete('{{ service.code }}', '{{ service.title }}')">
                ğŸ—‘ï¸ ì‚­ì œ
            </button>
        </div>
    </div>

    <!-- ìˆ˜ì • í¼ -->
    <div id="edit-{{ service.code }}" class="service-edit-form">
        <form method="POST" action="/admin/settings/pages/{{ service.code }}" enctype="multipart/form-data">
            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="tab-navigation">
                <button type="button" class="tab-button active" onclick="switchServiceTab(event, '{{ service.code }}', 'start')">
                    ì‹œì‘ í˜ì´ì§€
                </button>
                <button type="button" class="tab-button" onclick="switchServiceTab(event, '{{ service.code }}', 'result')">
                    ê²°ê³¼ í˜ì´ì§€
                </button>
            </div>

            <!-- ì‹œì‘ í˜ì´ì§€ íƒ­ -->
            <div id="tab-start-{{ service.code }}" class="tab-content active">
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label class="form-label">í˜ì´ì§€ ì£¼ì†Œ (URL)</label>
                        <input type="text" name="url_path" class="form-input" value="{{ service.url_path or '/fortune/' + service.code }}" placeholder="/fortune/saju">
                        <span class="form-hint">ì˜ˆ: /fortune/tarot, /saju (ìŠ¬ë˜ì‹œë¡œ ì‹œì‘)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì œëª© <span class="required">*</span></label>
                        <input type="text" name="title" class="form-input" value="{{ service.title }}" required>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ë¶€ì œëª© <span class="required">*</span></label>
                        <input type="text" name="subtitle" class="form-input" value="{{ service.subtitle }}" required>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ì„¤ëª… <span class="required">*</span></label>
                        <textarea name="description" class="form-textarea" required>{{ service.description }}</textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ì‹œì‘ í˜ì´ì§€ ìºë¦­í„° ì´ë¯¸ì§€/ì˜ìƒ</label>
                        <input type="file" id="character_form_{{ service.code }}" name="character_form_image_file"
                               class="form-file-input" accept="image/*,video/mp4,video/webm"
                               onchange="previewImage(this, 'character_form_preview_{{ service.code }}')">
                        <label for="character_form_{{ service.code }}" class="form-file-label">ğŸ“ íŒŒì¼ ì„ íƒ</label>
                        <span class="form-hint">3:4 ë¹„ìœ¨ ê¶Œì¥ (ì˜ˆ: 300x400px). ì‹œì‘ í˜ì´ì§€ ìƒë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤.</span>

                        {% if service.character_form_image %}
                        <div class="image-preview-wrapper mt-2">
                            <div class="image-preview-item sub-banner">
                                {% if service.character_form_image.endswith(('.mp4', '.webm')) or '.mp4?' in service.character_form_image or '.webm?' in service.character_form_image %}
                                    <video src="{{ service.character_form_image }}" controls></video>
                                {% else %}
                                    <img src="{{ service.character_form_image }}" alt="ì‹œì‘ í˜ì´ì§€ ì´ë¯¸ì§€">
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        <div id="character_form_preview_{{ service.code }}" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- ê²°ê³¼ í˜ì´ì§€ íƒ­ -->
            <div id="tab-result-{{ service.code }}" class="tab-content">
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label class="form-label">ê²°ê³¼ í˜ì´ì§€ ì£¼ì†Œ (URL)</label>
                        <input type="text" name="result_url_path" class="form-input" value="{{ service.result_url_path or service.url_path or '/fortune/' + service.code }}" placeholder="/fortune/saju">
                        <span class="form-hint">í¼ ì œì¶œ ì‹œ ì‚¬ìš©ë˜ëŠ” URLì…ë‹ˆë‹¤. ì‹œì‘ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •í•˜ì„¸ìš”. (GET=ì…ë ¥í¼, POST=ê²°ê³¼)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ìºë¦­í„° ì´ë¦„ <span class="required">*</span></label>
                        <input type="text" name="character_name" class="form-input" value="{{ service.character_name }}" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì´ëª¨ì§€ <span class="required">*</span></label>
                        <input type="text" name="character_emoji" class="form-input" value="{{ service.character_emoji }}" required maxlength="2">
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ê²°ê³¼ í˜ì´ì§€ ìºë¦­í„° ì´ë¯¸ì§€/ì˜ìƒ</label>
                        <input type="file" id="character_result_{{ service.code }}" name="character_image_file"
                               class="form-file-input" accept="image/*,video/mp4,video/webm"
                               onchange="previewImage(this, 'character_result_preview_{{ service.code }}')">
                        <label for="character_result_{{ service.code }}" class="form-file-label">ğŸ“ íŒŒì¼ ì„ íƒ</label>
                        <span class="form-hint">3:4 ë¹„ìœ¨ ê¶Œì¥ (ì˜ˆ: 300x400px). ê²°ê³¼ í˜ì´ì§€ì—ì„œ ì´ëª¨ì§€ ëŒ€ì‹  í‘œì‹œë©ë‹ˆë‹¤.</span>

                        {% if service.character_image %}
                        <div class="image-preview-wrapper mt-2">
                            <div class="image-preview-item sub-banner">
                                {% if service.character_image.endswith(('.mp4', '.webm')) or '.mp4?' in service.character_image or '.webm?' in service.character_image %}
                                    <video src="{{ service.character_image }}" controls></video>
                                {% else %}
                                    <img src="{{ service.character_image }}" alt="ê²°ê³¼ í˜ì´ì§€ ì´ë¯¸ì§€">
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        <div id="character_result_preview_{{ service.code }}" class="mt-2"></div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">ì„œë¹„ìŠ¤ í™œì„±í™”</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="is_active_{{ service.code }}" name="is_active"
                                   {% if service.is_active %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </div>
                        <span class="form-hint">ì´ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ì´íŠ¸ì— í‘œì‹œí•©ë‹ˆë‹¤</span>
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ë²„íŠ¼ -->
            <div class="form-actions">
                <div></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="toggleEdit('{{ service.code }}')">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ğŸ’¾ ì €ì¥
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<style>
/* ì„œë¹„ìŠ¤ ìºë¦­í„° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
.service-character {
    flex-shrink: 0;
}

.service-character-img {
    width: 80px;
    height: 107px;
    object-fit: cover;
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
}

.service-character-emoji {
    font-size: 64px;
    display: block;
    text-align: center;
}

/* ì„œë¹„ìŠ¤ ìˆ˜ì • í¼ */
.service-edit-form {
    display: none;
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--gray-200);
}

.service-edit-form.active {
    display: block;
}
</style>

<!-- ìƒˆ í˜ì´ì§€ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="newPageModal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">ìƒˆ í˜ì´ì§€ ì¶”ê°€</h2>
            <button type="button" class="modal-close" onclick="hideNewPageModal()">&times;</button>
        </div>
        <form method="POST" action="/admin/settings/pages/create">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">í˜ì´ì§€ ì£¼ì†Œ (URL) <span class="required">*</span></label>
                    <div style="display: flex; align-items: center; gap: 0;">
                        <span style="padding: 10px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-right: none; border-radius: 6px 0 0 6px; color: #6b7280; font-family: monospace;">/fortune/</span>
                        <input type="text" name="code" class="form-input" required pattern="[a-z0-9_]+" placeholder="tarot" style="border-radius: 0 6px 6px 0; flex: 1;">
                    </div>
                    <span class="form-hint">ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© (ì˜ˆ: tarot, zodiac, love2024)</span>
                </div>

                <!-- ì‹œì‘ í˜ì´ì§€ ì„¹ì…˜ -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #3b82f6; margin-bottom: 16px;">ğŸ“ ì‹œì‘ í˜ì´ì§€ ì„¤ì •</h3>

                    <div class="form-group">
                        <label class="form-label">ì œëª© <span class="required">*</span></label>
                        <input type="text" name="title" class="form-input" required placeholder="ì˜ˆ: íƒ€ë¡œ ìš´ì„¸">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ë¶€ì œëª© <span class="required">*</span></label>
                        <input type="text" name="subtitle" class="form-input" required placeholder="ì˜ˆ: ì¹´ë“œê°€ ì•Œë ¤ë“œë ¤ìš”">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì„¤ëª… <span class="required">*</span></label>
                        <textarea name="description" class="form-textarea" required placeholder="ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                </div>

                <!-- ê²°ê³¼ í˜ì´ì§€ ì„¹ì…˜ -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #8b5cf6; margin-bottom: 16px;">ğŸ¯ ê²°ê³¼ í˜ì´ì§€ ì„¤ì •</h3>

                    <div class="form-group">
                        <label class="form-label">ìºë¦­í„° ì´ë¦„ <span class="required">*</span></label>
                        <input type="text" name="character_name" class="form-input" required placeholder="ì˜ˆ: íƒ€ë¡œë§ˆìŠ¤í„°">
                        <span class="form-hint">ì‹œì‘ í˜ì´ì§€ì™€ ê²°ê³¼ í˜ì´ì§€ì—ì„œ ëª¨ë‘ ì‚¬ìš©ë©ë‹ˆë‹¤</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì´ëª¨ì§€ <span class="required">*</span></label>
                        <input type="text" name="character_emoji" class="form-input" required maxlength="2" placeholder="ì˜ˆ: ğŸ”®">
                        <span class="form-hint">ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ ëŒ€ì²´ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤</span>
                    </div>

                    <p style="font-size: 13px; color: #6b7280; margin-top: 16px;">
                        í˜ì´ì§€ ìƒì„± í›„ 'í˜ì´ì§€ ì„¤ì •'ì—ì„œ ì‹œì‘ í˜ì´ì§€/ê²°ê³¼ í˜ì´ì§€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideNewPageModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ìƒì„±</button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleEdit(code) {
    const form = document.getElementById('edit-' + code);
    form.classList.toggle('active');
}

function switchServiceTab(event, serviceCode, tabName) {
    const form = document.getElementById('edit-' + serviceCode);

    // íƒ­ ë²„íŠ¼ í™œì„±í™”
    const tabButtons = form.querySelectorAll('.tab-button');
    tabButtons.forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');

    // íƒ­ ì½˜í…ì¸  í‘œì‹œ
    const tabContents = form.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.classList.remove('active'));

    const targetTab = document.getElementById('tab-' + tabName + '-' + serviceCode);
    if (targetTab) {
        targetTab.classList.add('active');
    }
}

function showNewPageModal() {
    document.getElementById('newPageModal').style.display = 'flex';
}

function hideNewPageModal() {
    document.getElementById('newPageModal').style.display = 'none';
}

function confirmDelete(code, title) {
    if (confirm(`ì •ë§ë¡œ "${title}" í˜ì´ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) {
        // í¼ ìƒì„±í•˜ì—¬ DELETE ìš”ì²­
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/settings/pages/${code}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(event) {
    const modal = document.getElementById('newPageModal');
    if (event.target === modal) {
        hideNewPageModal();
    }
});
</script>
{% endblock %}
